






<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2022-06-16 10:59:19 -0400">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    
    <link rel="license" href="#license-info" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - DiscovR Workshop Curriculum"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="/assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="/assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="/assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="/assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  R for Data Cleaning and Merging &ndash; DiscovR Workshop Curriculum
  </title>  

  </head>
  <body>

    


<div class="panel panel-default life-cycle">
  <div id="life-cycle" class="panel-body pre-alpha">
    This lesson is still being designed and assembled (Pre-Alpha version)
  </div>
</div>





    <div class="container">
      
















  
  










<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="/assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="/index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="/CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="/setup.html">Setup</a></li>

        
        
        <li class="dropdown">
          <a href="/" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            
            <li><a href="/00-intro/index.html">Introduction to The DiscovR Workshop</a></li>
            
            
            <li><a href="/01-r-getting-started/index.html">Getting Started with R</a></li>
            
            
            <li><a href="/02-r-plotting/index.html">R for Plotting</a></li>
            
            
            <li><a href="/03-r-data-analysis/index.html">R for Data Analysis</a></li>
            
            
            <li><a href="/04-r-data-cleaning-merging/index.html">R for Data Cleaning and Merging</a></li>
            
            
            <li><a href="/05-r-markdown/index.html">Writing Reports with R Markdown</a></li>
            
            
            <li><a href="/06-conclusion/index.html">Conclusion</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="/aio/index.html">All in one page (Beta)</a></li>
          </ul>
        </li>
        
	

	
	
        <li class="dropdown">
          <a href="/" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/reference.html">Reference</a></li>
            
            
            
              <li><a href="/about/index.html">About</a></li>
            
            
            
            
              <li><a href="/guide/index.html">Instructor Notes</a></li>
            
            
          </ul>
        </li>
	

	
        <li><a href="/LICENSE.html">License</a></li>
	
	
	<li><a href="/edit//_episodes_rmd/04-r-data-cleaning-merging.Rmd" data-checker-ignore>Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>



















  
  











<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="/03-r-data-analysis/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="/">DiscovR Workshop Curriculum</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="/05-r-markdown/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">R for Data Cleaning and Merging</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>












<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 75 min
      <br/>
      <strong>Exercises:</strong> 15 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How can I combine two datasets from different sources?</p>
</li>
	
	<li><p>How can data tidying facilitate answering analysis questions?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>To become familiar with more functions of the <code class="language-plaintext highlighter-rouge">dplyr</code> and <code class="language-plaintext highlighter-rouge">tidyr</code> packages.</p>
</li>
	
	<li><p>To be able to use <code class="language-plaintext highlighter-rouge">dplyr</code> and <code class="language-plaintext highlighter-rouge">tidyr</code> to prepare data for analysis.</p>
</li>
	
	<li><p>To be able to combine two different data sources using joins.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h3 id="contents">Contents</h3>

<ol>
  <li><a href="#cleaning-up-data">Cleaning up data</a></li>
  <li><a href="#joining-data-frames">Joining data frames</a></li>
  <li><a href="#analyzing-combined-data">Analyzing combined data</a></li>
</ol>

<h1 id="cleaning-up-data">Cleaning up data</h1>

<p><a href="#contents"><em>Back to top</em></a></p>

<p>Researchers are often pulling data from several sources, and the process of making data compatible with one another and prepared for analysis can be a large undertaking. Luckily, there are many functions that allow us to do this in R. We’ve been working with the gapminder dataset, which contains population and GDP data by year. In this section, we practice cleaning and preparing a second dataset containing CO2 emissions data by country and year, sourced from <a href="https://data.un.org/_Docs/SYB/CSV/SYB63_310_202009_Carbon%20Dioxide%20Emission%20Estimates.csv">the UN</a>.</p>

<p>It’s always good to go into data cleaning with a clear goal in mind. Here, we’d like to prepare the CO2 UN data to be compatible with our gapminder data so we can directly compare GDP to CO2 emissions. To make this work, we’d like a data frame that contains a column with the country name, and columns for different ways of measuring CO2 emissions. We will also want the data to be collected as close to 2007 as possible (the last year we have data for in gapminder). Let’s start with reading the data in using <code class="language-plaintext highlighter-rouge">read_csv()</code></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/co2-un-data.csv"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/co2-un-data.csv"): could not find function "read_csv"
</code></pre></div></div>

<p>The output gives us a warning about missing column names being filled in with things like ‘X3’, ‘X4’, etc. Looking at the table that is outputted by <code class="language-plaintext highlighter-rouge">read_csv()</code> we can see that there appear to be two rows at the top of the file that contain information about the data in the table. The first is a header that tells us the table number and its name. Ideally, we’d skip that. We can do this using the <code class="language-plaintext highlighter-rouge">skip=</code> argument in read_csv by giving it a number of lines to skip.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/co2-un-data.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/co2-un-data.csv", skip = 1): could not find function "read_csv"
</code></pre></div></div>

<p>Now we get a similar Warning message as before, but the outputted table looks better.</p>

<blockquote>
  <h2 id="warnings-and-errors">Warnings and Errors</h2>
  <p>It’s important to differentiate between Warnings and Errors in R. A warning tells us, “you might want to know about this issue, but R still did what you asked”. An error tells us, “there’s something wrong with your code or your data and R didn’t do what you asked”. You need to fix any errors that arise. Warnings, are probably best to resolve or at least understand why they are coming up.
{.callout}</p>
</blockquote>

<p>We can resolve this warning by telling <code class="language-plaintext highlighter-rouge">read_csv()</code> what the column names should be with the <code class="language-plaintext highlighter-rouge">col_names()</code> argument where we give it the column names we want within the c() function separated by commas. If we do this, then we need to set skip to 2 to also skip the column headings. Let’s also save this dataframe to <code class="language-plaintext highlighter-rouge">co2_emissions_dirty</code> so that we don’t have to read it in every time we want to clean it even more.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/co2-un-data.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w">
         </span><span class="n">col_names</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"region"</span><span class="p">,</span><span class="w"> </span><span class="s2">"country"</span><span class="p">,</span><span class="w"> </span><span class="s2">"year"</span><span class="p">,</span><span class="w"> </span><span class="s2">"series"</span><span class="p">,</span><span class="w"> </span><span class="s2">"value"</span><span class="p">,</span><span class="w"> </span><span class="s2">"footnotes"</span><span class="p">,</span><span class="w"> </span><span class="s2">"source"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/co2-un-data.csv", skip = 2, col_names = c("region", : could not find function "read_csv"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in eval(expr, envir, enclos): object 'co2_emissions_dirty' not found
</code></pre></div></div>

<blockquote class="solution">
  <h2 id="bonus-another-way-to-deal-with-this-error">Bonus: Another way to deal with this error</h2>

  <p>There are often multiple ways to clean data. Here we  read in the table, get the warning and then fix the column names using the rename function.</p>

  <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/co2-un-data.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rename</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">X2</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>

  <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/co2-un-data.csv", skip = 1) %&gt;% rename(country = X2): could not find function "%&gt;%"
</code></pre></div>  </div>

  <p>Many data analysts prefer to have their column headings and variable names be in all lower case. We can use a variation of <code class="language-plaintext highlighter-rouge">rename()</code>, which is <code class="language-plaintext highlighter-rouge">rename_all()</code> that allows us to set all of the column headings to lower case by giving it the name of the tolower function, which makes everything lowercase.</p>

  <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/co2-un-data.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">rename_all</span><span class="p">(</span><span class="n">tolower</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>

  <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/co2-un-data.csv", skip = 1) %&gt;% rename_all(tolower): could not find function "%&gt;%"
</code></pre></div>  </div>
</blockquote>

<p>We previously saw how we can subset columns from a data frame using the select function. There are a lot of columns with extraneous information in this dataset, let’s subset out the columns we are interested in.</p>

<blockquote class="challenge">
  <h2 id="reviewing-selecting-columns">Reviewing selecting columns</h2>
  <p>Select the country, year, series, and value columns from our dataset.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution:</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in co2_emissions_dirty %&gt;% select(country, year, series, value): could not find function "%&gt;%"
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<p>The series column has two methods of quantifying CO2 emissions - “Emissions (thousand metric tons of carbon dioxide)” and “Emissions per capita (metric tons of carbon dioxide)”. Those are long titles that we’d like to shorten to make them easier to work with. We can shorten them to “total_emissions” and “per_capita_emissions” using the recode function. We need to do this within the mutate function where we will mutate the series column. The syntax in the recode function is to tell recode which column we want to recode and then what the old value (e.g. “Emissions (thousand metric tons of carbon dioxide)”) should equal after recoding (e.g. “total”).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="s2">"Emissions (thousand metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"total_emissions"</span><span class="p">,</span><span class="w">
                         </span><span class="s2">"Emissions per capita (metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"per_capita_emissions"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in co2_emissions_dirty %&gt;% select(country, year, series, value) %&gt;% : could not find function "%&gt;%"
</code></pre></div></div>

<p>Recall that we’d like to have separate columns for the two ways that we CO2 emissions data. To achieve this, we’ll use the pivot_wider function that we saw previously. The columns we want to spread out are series (i.e. names_from) and value (i.e. values_from).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="s2">"Emissions (thousand metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"total_emission"</span><span class="p">,</span><span class="w">
                         </span><span class="s2">"Emissions per capita (metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"per_capita_emission"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="o">=</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in co2_emissions_dirty %&gt;% select(country, year, series, value) %&gt;% : could not find function "%&gt;%"
</code></pre></div></div>

<p>Excellent! The last step before we can join this data frame is to get the most data that is for the year closest to 2007 so we can make a more direct comparison to the most recent data we have from gapminder. For the sake of time, we’ll just tell you that we want data from 2005.</p>

<blockquote class="solution">
  <h2 id="bonus-how-did-we-determine-that-2005-is-the-closest-year-to-2007">Bonus: How did we determine that 2005 is the closest year to 2007?</h2>

  <p>We want to make sure we pick a year that is close to 2005, but also a year that has a decent amount of data to work with. One useful tool is the <code class="language-plaintext highlighter-rouge">count()</code> function, which will tell us how many times a value is repeated in a column of a data frame. Let’s use this function on the year column to see which years we have data for and to tell us whether we have a good number of countries represented in that year.</p>

  <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">mutate</span><span class="p">(</span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="s2">"Emissions (thousand metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"total"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"Emissions per capita (metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"per_capita"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="o">=</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">count</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>

  <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in co2_emissions_dirty %&gt;% select(country, year, series, value) %&gt;% : could not find function "%&gt;%"
</code></pre></div>  </div>

  <p>It looks like we have data for 140 countries in 2005 and 2010. We chose 2005 because it is closer to 2007.</p>
</blockquote>

<blockquote class="challenge">
  <h2 id="filtering-rows-and-removing-columns">Filtering rows and removing columns</h2>
  <p>Filter out data from 2005 and then drop the year column. (Since we will have only data from one year, it is now irrelevant.)</p>

  <blockquote class="solution">
    <h2 id="solution-1">Solution:</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">mutate</span><span class="p">(</span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="s2">"Emissions (thousand metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"total"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"Emissions per capita (metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"per_capita"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="o">=</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="o">==</span><span class="m">2005</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
 </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in co2_emissions_dirty %&gt;% select(country, year, series, value) %&gt;% : could not find function "%&gt;%"
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<p>Finally, let’s go ahead and assign the output of this code chunk, which is the cleaned dataframe, to a variable name:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">co2_emissions_dirty</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="s2">"Emissions (thousand metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"total_emission"</span><span class="p">,</span><span class="w">
                         </span><span class="s2">"Emissions per capita (metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"per_capita_emission"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="o">=</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="o">==</span><span class="m">2005</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in co2_emissions_dirty %&gt;% select(country, year, series, value) %&gt;% : could not find function "%&gt;%"
</code></pre></div></div>

<blockquote>
  <p><strong>Looking at your data:</strong> You can get a look at your data-cleaning hard work by navigating to the <strong>Environment</strong> tab in RStudio and clicking the table icon next to the variable name. Notice when we do this, RStudio automatically runs the <code class="language-plaintext highlighter-rouge">View()</code> command. We’ve made a lot of progress!
{.callout}</p>
</blockquote>

<h1 id="joining-data-frames">Joining data frames</h1>

<p><a href="#contents"><em>Back to top</em></a></p>

<p>Now we’re ready to join our CO2 emissions data to the gapminder data. Previously we saw that we could read in and filter the gapminder data like this to get the data from the Americas for 2007 so we can create a new dataframe with our filtered data:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_data_2007</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/gapminder_data.csv"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2007</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Americas"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">continent</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/gapminder_data.csv") %&gt;% filter(year == 2007 &amp; : could not find function "%&gt;%"
</code></pre></div></div>

<p>Look at the data in <code class="language-plaintext highlighter-rouge">co2_emissions</code> and <code class="language-plaintext highlighter-rouge">gapminder_data_2007</code>. If you had to merge these two data frames together, which column would you use to merge them together? If you said “country” - good job!</p>

<p>We’ll call country our “key”. Now, when we join them together, can you think of any problems we might run into when we merge things? We might not have CO2 emissions data for all of the countries in the gapminder dataset and vice versa. Also, a country might be represented in both data frames but not by the same name in both places. As an example, write down the name of the country that the University of Michigan is in - we’ll come back to your answer shortly!</p>

<p>The dplyr package has a number of tools for joining data frames together depending on what we want to do with the rows of the data of countries that are not represented in both data frames. Here we’ll be using <code class="language-plaintext highlighter-rouge">inner_join()</code> and <code class="language-plaintext highlighter-rouge">anti_join()</code>.</p>

<p>In an “inner join”, the new data frame only has those rows where the same key is found in both data frames. This is a very commonly used join.</p>

<p><img src="../fig/r-data-analysis/join-inner.png" alt="" /></p>

<blockquote class="solution">
  <h2 id="bonus-other-dplyr-join-functions">Bonus: Other dplyr join functions</h2>

  <p>Outer joins and can be performed using <code class="language-plaintext highlighter-rouge">left_join()</code>, <code class="language-plaintext highlighter-rouge">right_join()</code>, and <code class="language-plaintext highlighter-rouge">full_join()</code>. In a “left join”, if the key is present in the left hand data frame, it will appear in the output, even if it is not found in the the right hand data frame. For a right join, the opposite is true. For a full join, all possible keys are included in the output data frame.</p>

  <p><img src="../fig/r-data-analysis/join-outer.png" alt="" /></p>
</blockquote>

<p>If you don’t already have it read in, read in the gapminder data:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'data/gapminder_data.csv'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/gapminder_data.csv"): could not find function "read_csv"
</code></pre></div></div>

<p>Let’s give the <code class="language-plaintext highlighter-rouge">inner_join()</code> function a try.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inner_join</span><span class="p">(</span><span class="n">gapminder_data</span><span class="p">,</span><span class="w"> </span><span class="n">co2_emissions</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in inner_join(gapminder_data, co2_emissions): could not find function "inner_join"
</code></pre></div></div>

<p>Do you see that we now have data from both data frames joined together in the same data frame? One thing to note about the output is that <code class="language-plaintext highlighter-rouge">inner_join()</code> tells us that that it joined by “country”. We can make this explicit using the “by” argument in the join functions</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inner_join</span><span class="p">(</span><span class="n">gapminder_data</span><span class="p">,</span><span class="w"> </span><span class="n">co2_emissions</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"country"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in inner_join(gapminder_data, co2_emissions, by = "country"): could not find function "inner_join"
</code></pre></div></div>

<p>One thing to notice is that gapminder data had 25 rows, but the output of our join only had 21. Let’s investigate. It appears that there must have been countries in the gapminder data that did not appear in our co2_emissions data frame.</p>

<p>Let’s use <code class="language-plaintext highlighter-rouge">anti_join()</code> for this - this will show us the data for the keys on the left that are missing from the data frame on the right.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anti_join</span><span class="p">(</span><span class="n">gapminder_data</span><span class="p">,</span><span class="w"> </span><span class="n">co2_emissions</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"country"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in anti_join(gapminder_data, co2_emissions, by = "country"): could not find function "anti_join"
</code></pre></div></div>
<p>We can see that the co2_emissions data were missing for Bolivia, Puerto Rico, United States, and Venezuela.</p>

<p>If we look at the co2_emissions data with <code class="language-plaintext highlighter-rouge">View()</code>, we will see that Bolivia, United States, and Venezuela are called different things in the co2_emissions data frame. They’re called “Bolivia (Plurin. State of)”, “United States of America”, and “Venezuela (Boliv. Rep. of)”. Puerto Rico isn’t a country; it’s part of the United States. Using <code class="language-plaintext highlighter-rouge">mutate()</code> and <code class="language-plaintext highlighter-rouge">recode()</code>, we can re-import the co2_emissions data so that the country names for Bolivia, United States, and Venezuela, match those in the gapminder data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">co2_emissions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/co2-un-data.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w">
                          </span><span class="n">col_names</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"region"</span><span class="p">,</span><span class="w"> </span><span class="s2">"country"</span><span class="p">,</span><span class="w"> </span><span class="s2">"year"</span><span class="p">,</span><span class="w">
                                      </span><span class="s2">"series"</span><span class="p">,</span><span class="w"> </span><span class="s2">"value"</span><span class="p">,</span><span class="w"> </span><span class="s2">"footnotes"</span><span class="p">,</span><span class="w"> </span><span class="s2">"source"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">series</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="s2">"Emissions (thousand metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"total"</span><span class="p">,</span><span class="w">
                         </span><span class="s2">"Emissions per capita (metric tons of carbon dioxide)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"per_capita"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="o">=</span><span class="n">series</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="o">==</span><span class="m">2005</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">recode</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"Bolivia (Plurin. State of)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bolivia"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"United States of America"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"United States"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"Venezuela (Boliv. Rep. of)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Venezuela"</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/co2-un-data.csv", skip = 2, col_names = c("region", : could not find function "%&gt;%"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anti_join</span><span class="p">(</span><span class="n">gapminder_data</span><span class="p">,</span><span class="w"> </span><span class="n">co2_emissions</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"country"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in anti_join(gapminder_data, co2_emissions, by = "country"): could not find function "anti_join"
</code></pre></div></div>

<p>Now we see that our recode enabled the join for all countries in the gapminder, and we are left with Puerto Rico. In the next exercise, let’s recode Puerto Rico as United States in the gapminder data and then use <code class="language-plaintext highlighter-rouge">group_by()</code> and <code class="language-plaintext highlighter-rouge">summarize()</code> to aggregate the data; we’ll use the population data to weight the life expectancy and GDP values.</p>

<p>In the gapminder data, let’s recode Puerto Rico as United States.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/gapminder_data.csv"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2007</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Americas"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">continent</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="s2">"Puerto Rico"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"United States"</span><span class="p">))</span><span class="w"> 
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/gapminder_data.csv") %&gt;% filter(year == 2007 &amp; : could not find function "%&gt;%"
</code></pre></div></div>

<p>Now we have to group Puerto Rico and the US together, aggregating and calculating the data for all of the other columns. This is a little tricky - we will need a weighted average of lifeExp and gdpPercap. You can do this using standard order of operations.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data/gapminder_data.csv"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2007</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Americas"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">continent</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="s2">"Puerto Rico"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"United States"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">lifeExp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">lifeExp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pop</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">),</span><span class="w">
            </span><span class="n">gdpPercap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">gdpPercap</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pop</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">),</span><span class="w">
            </span><span class="n">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in read_csv("data/gapminder_data.csv") %&gt;% filter(year == 2007 &amp; : could not find function "%&gt;%"
</code></pre></div></div>

<p>Let’s check to see if it worked!</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anti_join</span><span class="p">(</span><span class="n">gapminder_data</span><span class="p">,</span><span class="w"> </span><span class="n">co2_emissions</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"country"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in anti_join(gapminder_data, co2_emissions, by = "country"): could not find function "anti_join"
</code></pre></div></div>
<p>Now our <code class="language-plaintext highlighter-rouge">anti_join()</code> returns an empty data frame, which tells us that we have reconciled all of the keys from the gapminder data with the data in the co2_emissions data frame.</p>

<p>Finally, let’s use the <code class="language-plaintext highlighter-rouge">inner_join()</code> to create a new data frame:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_co2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">inner_join</span><span class="p">(</span><span class="n">gapminder_data</span><span class="p">,</span><span class="w"> </span><span class="n">co2_emissions</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"country"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in inner_join(gapminder_data, co2_emissions, by = "country"): could not find function "inner_join"
</code></pre></div></div>

<p>One last thing! What if we’re interested in distinguishing between countries in North America and South America? We want to create two groups - Canada, the United States, and Mexico in one and the other countries in another.</p>

<p>We can create a grouping variable using <code class="language-plaintext highlighter-rouge">mutate()</code> combined with an <code class="language-plaintext highlighter-rouge">if_else()</code> function - a very useful pairing.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_co2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">  
</span><span class="n">mutate</span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Canada"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"United States"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Mexico"</span><span class="p">,</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w"> </span><span class="s2">"south"</span><span class="p">))</span><span class="w">  
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in gapminder_co2 %&gt;% mutate(region = if_else(country == "Canada" | : could not find function "%&gt;%"
</code></pre></div></div>
<p>Let’s look at the output - see how the Canada, US, and Mexico rows are all labeled as “north” and everything else is labeled as “south”</p>

<p>We have reached our data cleaning goals! One of the best aspects of doing all of these steps coded in R is that our efforts are reproducible, and the raw data is maintained. With good documentation of data cleaning and analysis steps, we could easily share our work with another researcher who would be able to repeat what we’ve done. However, it’s also nice to have a saved <code class="language-plaintext highlighter-rouge">csv</code> copy of our clean data. That way we can access it later without needing to redo our data cleaning, and we can also share the cleaned data with collaborators. To save our dataframe, we’ll use <code class="language-plaintext highlighter-rouge">write_csv()</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">write_csv</span><span class="p">(</span><span class="n">gapminder_co2</span><span class="p">,</span><span class="w"> </span><span class="s2">"data/gapminder_co2.csv"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in write_csv(gapminder_co2, "data/gapminder_co2.csv"): could not find function "write_csv"
</code></pre></div></div>

<p>Great - Now we can move on to the analysis!</p>

<h1 id="analyzing-combined-data">Analyzing combined data</h1>

<p><a href="#contents"><em>Back to top</em></a></p>

<p>For our analysis, we have two questions we’d like to answer. First, is there a relationship between the GDP of a country and the amount of CO2 emitted (per capita)? Second, Canada, the United States, and Mexico account for nearly half of the population of the Americas. What percent of the total CO2 production do they account for?</p>

<p>To answer the first question, we’ll plot the CO2 emitted (on a per capita basis) against the GDP (on a per capita basis) using a scatter plot:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">gapminder_co2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">gdpPercap</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">per_capita</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"GDP (per capita)"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="o">=</span><span class="s2">"CO2 emitted (per capita)"</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="o">=</span><span class="s2">"There is a strong association between a nation's GDP \nand the amount of CO2 it produces"</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in ggplot(gapminder_co2, aes(x = gdpPercap, y = per_capita)): could not find function "ggplot"
</code></pre></div></div>

<p><em>Tip:</em> Notice we used the <code class="language-plaintext highlighter-rouge">\n</code> in our title to get a new line to prevent it from getting cut off.</p>

<p>To help clarify the association, we can add a fit line through the data using <code class="language-plaintext highlighter-rouge">geom_smooth()</code></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">gapminder_co2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">gdpPercap</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">per_capita</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"GDP (per capita)"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="o">=</span><span class="s2">"CO2 emitted (per capita)"</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="o">=</span><span class="s2">"There is a strong association between a nation's GDP \nand the amount of CO2 it produces"</span><span class="w">
  </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in ggplot(gapminder_co2, aes(x = gdpPercap, y = per_capita)): could not find function "ggplot"
</code></pre></div></div>

<p>We can force the line to be straight using <code class="language-plaintext highlighter-rouge">method="lm"</code> as an argument to <code class="language-plaintext highlighter-rouge">geom_smooth</code></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">gapminder_co2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">gdpPercap</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">per_capita</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"GDP (per capita)"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="o">=</span><span class="s2">"CO2 emitted (per capita)"</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="o">=</span><span class="s2">"There is a strong association between a nation's GDP \nand the amount of CO2 it produces"</span><span class="w">
  </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">"lm"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in ggplot(gapminder_co2, aes(x = gdpPercap, y = per_capita)): could not find function "ggplot"
</code></pre></div></div>

<p>To answer our first question, as the title of our plot indicates there is indeed a strong association between a nation’s GDP and the amount of CO2 it produces.</p>

<p>For the second question, we want to create two groups - Canada, the United States, and Mexico in one and the other countries in another.</p>

<p>We can create a grouping variable using <code class="language-plaintext highlighter-rouge">mutate()</code> combined with an <code class="language-plaintext highlighter-rouge">if_else()</code> function - a very useful pairing.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_co2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Canada"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"United States"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Mexico"</span><span class="p">,</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w"> </span><span class="s2">"south"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in gapminder_co2 %&gt;% mutate(region = if_else(country == "Canada" | : could not find function "%&gt;%"
</code></pre></div></div>

<p>Now we can use this column to repeat our <code class="language-plaintext highlighter-rouge">group_by()</code> and <code class="language-plaintext highlighter-rouge">summarize()</code> steps</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_co2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Canada"</span><span class="w"> </span><span class="o">|</span><span class="w">
                            </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"United States"</span><span class="w"> </span><span class="o">|</span><span class="w">
                            </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Mexico"</span><span class="p">,</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w"> </span><span class="s2">"south"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">region</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">sumtotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">total</span><span class="p">),</span><span class="w">
            </span><span class="n">sumpop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in gapminder_co2 %&gt;% mutate(region = if_else(country == "Canada" | : could not find function "%&gt;%"
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">if_else()</code> statement reads like, “if country equals “Canada” OR <code class="language-plaintext highlighter-rouge">|</code> “United states” OR “Mexico”, the new variable region should be “north”, else “south””. It’s worth exploring logical operators for “or” <code class="language-plaintext highlighter-rouge">|</code>, “and” <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, and “not” <code class="language-plaintext highlighter-rouge">!</code>, which opens up a great deal of possibilities for writing code to do what you want.</p>

<p>We see that although Canada, the United States, and Mexico account for close to half the population of the Americas, they account for 88% of the CO2 emitted. We just did this math quickly by plugging the numbers from our table into the console to get the percentages. Can we make that a little more reproducible by calculating percentages for population (pop) and total emissions (total) into our data before summarizing?</p>

<h1 id="bonus">Bonus</h1>

<h2 id="bonus-exercise">Bonus exercise</h2>

<blockquote class="challenge">
  <h2 id="calculating-percent">Calculating percent</h2>

  <p>What percentage of the population and CO2 emissions in the Americas does the United States make up? What percentage of the population and CO2 emission does North America make up?</p>

  <blockquote class="solution">
    <h2 id="solution-2">Solution</h2>

    <p>Create a new variable using <code class="language-plaintext highlighter-rouge">mutate()</code> that calculates percentages for the pop and total variables.</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_co2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Canada"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"United States"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Mexico"</span><span class="p">,</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w"> </span><span class="s2">"south"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">totalPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">*</span><span class="m">100</span><span class="p">,</span><span class="w">
         </span><span class="n">popPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span><span class="o">*</span><span class="m">100</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in gapminder_co2 %&gt;% mutate(region = if_else(country == "Canada" | : could not find function "%&gt;%"
</code></pre></div>    </div>

    <p>This table shows that the United states makes up 33% of the population of the Americas, but accounts for 77% of total emissions. Now let’s take a look at population and emission for the two different continents:</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gapminder_co2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Canada"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"United States"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Mexico"</span><span class="p">,</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w"> </span><span class="s2">"south"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">totalPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">*</span><span class="m">100</span><span class="p">,</span><span class="w">
         </span><span class="n">popPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span><span class="o">*</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">region</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarize</span><span class="p">(</span><span class="n">sumTotalPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">totalPercent</span><span class="p">),</span><span class="w">
            </span><span class="n">sumPopPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">popPercent</span><span class="p">))</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext error highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error in gapminder_co2 %&gt;% mutate(region = if_else(country == "Canada" | : could not find function "%&gt;%"
</code></pre></div>    </div>

  </blockquote>
</blockquote>






<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Assessing data source and structure is an important first step in analysis.</p>
</li>
    
    <li><p>Data analysis in R facilitates reproducible research.</p>
</li>
    
    <li><p>Preparing data for analysis can take significant effort and planning.</p>
</li>
    
  </ul>
</blockquote>

</article>


















  
  











<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="/03-r-data-analysis/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="/05-r-markdown/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 license" id="license-info" align="left">
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2022
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	
	<a href="/edit//_episodes_rmd/04-r-data-cleaning-merging.Rmd" data-checker-ignore>Edit on GitHub</a>
	
	
	/
	<a href="/blob//CONTRIBUTING.md" data-checker-ignore>Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:zena.lapp@duke.edu">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/lesson.js"></script>


<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
  _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io"]]);
  _paq.push(["setDoNotTrack", true]);
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://carpentries.matomo.cloud/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src='//cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->


<script src="/assets/js/anchor.min.js"></script>
<script>
    anchors.add();
</script>

  </body>
</html>
