---
source: Rmd
title: "Writing Reports with R Markdown"
teaching: 105
exercises: 30
questions:
- "How can I make reproducible reports using R Markdown?"
- "How do I format text using Markdown?"
objectives:
- "To create a report in R Markdown that combines text, code, and figures."
- "To use Markdown to format our report."
- "To understand how to use R code chunks to include or hide code, figures, and messages."
- "To be aware of the various report formats that can be rendered using R Markdown."
keypoints:
  - "R Markdown is a useful way to create a report that integrates text, code, and figures."
  - "Options such as `include` and `echo` determine what parts of an R code chunk are included in the R Markdown report. "
  - "R Markdown can render HTML, PDF, and Microsoft Word outputs."
---

```{r, include=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("05-")
```


```{r echo=FALSE}
# prevents jitter plots from changing
set.seed(20210109)
```

### Contents
1. [R for data analysis review](#r-for-data-analysis-review)
1. [What is R Markdown and why use it?](#why-use-r-markdown)
1. [Creating an R Markdown file](#creating-an-r-markdown-file)
1. [Basic components of R Markdown](#basic-components-of-r-markdown)
    + [Header](#header)
    + [Code chunks](#code-chunks)
    + [Text](#text)
1. [Starting the report](#starting-the-report)
    + [Change knit directory](#change-knit-directory)
    + [Add code](#add-code)
    + [Plot](#plot)
    + [Table](#table)
    + [Knitting](#knitting)
1. [Customizing the report](#customizing-the-report)
    + [Table format](#table-format)
    + [Messages](#messages)
    + [Code](#code)
    + [Bonus](#bonus)
1. [Formatting](#formatting)
    + [Headers](#headers)
    + [Lists](#lists)
    + [Hyperlinks](#hyperlinks)
1. [Applying it to your own data](#applying-it-to-your-own-data)

## R for data analysis review

Remember that yesterday we made a scatter plot of year vs. population, separated into a plot for each contient, and that it had 2 outliers:

```{r, message = FALSE}
library(tidyverse)
smoking <- read_csv('data/smoking_cancer.csv')

smoking %>% 
  ggplot(aes(x=year,y=pop)) +
  geom_point() +
  facet_wrap(vars(continent))
```

Write some code to figure out which countries these are (even if you already know!).

> ## Solution
> ```{r}
> smoking %>% filter(pop > 5e8) %>% select(country) %>% unique()
> ```
> Here we introduced a new function: `unique()`. 
> This function is not required to find the answer to this question, but it helps us get the answer a bit more quickly.
{: .solution}

Next, plot year vs. population separated into a plot for each continent but excluding the 2 outlier countries. Note that usually you don't want to exclude certain data points from a plot because it is misleading (see Bonus 2 for an alternative). 

> ## Solution
> ```{r}
> smoking %>% 
> filter(country != 'China') %>% 
> filter(country != 'India') %>% 
> ggplot(aes(x=year,y=pop)) +
> geom_point() +
> facet_wrap(vars(continent))
> ```
> Another solution is to use only one filter command and separate the two true/false statements with an ampersand (`&`), which means that you want to exclude both China and India:
> ```{r}
> smoking %>% 
> filter(country != 'China' & country != 'India') %>% 
> ggplot(aes(x=year,y=pop)) +
> geom_point() +
> facet_wrap(vars(continent))
> ```
{: .solution}

Bonus 1: Instead of hard-coding the two countries to remove them, remove the two outliers by combining your solutions to the first two questions.

> ## Solution
> ```{r}
> smoking %>% 
> filter(pop < 5e8) %>% 
> ggplot(aes(x=year,y=pop)) +
> geom_point() +
> facet_wrap(vars(continent))
> ```
{: .solution}

Bonus 2: How can you make the differences between countries more visible on the plot without excluding the two countries you identified above?

> ## Solution
> You can scale the y axis using a log10 scale to make the differences more visible:
> ```{r}
> smoking %>% 
> ggplot(aes(x=year,y=pop)) +
> geom_point() +
> scale_y_log10() +
> facet_wrap(vars(continent))
> ```
{: .solution}


## What is R Markdown and why use it?
_[Back to top](#contents)_

Recall that our goal is to generate a report to the United Nations on how a country's smoking rate is related to its lung cancer rate.

> ## Discusion
> How do you usually share data analyses with your collaborators? 
> > ## Solution
> > Many people share them through a Word or PDF document, a spreadsheet, slides, a graphic, etc.
> {: .solution}
{: .discussion}

In R Markdown, you can incorporate ordinary text (ex. experimental methods, analysis and discussion of results) alongside code and figures! (Some people write entire manuscripts in R Markdown.) This is useful for writing reproducible reports and publications, sharing work with collaborators, writing up homework, and keeping a bioinformatics notebook. Because the code is emedded in the document, the tables and figures are *reproducible*. Anyone can run the code and get the same results. If you find an error or want to add more to the report, you can just re-run the document and you'll have updated tables and figures! This concept of combining text and code is called "literate programming". To do this we use R Markdown, which combines Markdown (renders plain text) with R. You can output an html, PDF, or Word document that you can share with others. In fact, this webpage is an example of a rendered R markdown file!

(If you are familiar with Jupyter notebooks in the Python programming environment, R Markdown is  R's equivalent of a Jupyter notebook.)

## Creating an R Markdown file
_[Back to top](#contents)_

Now that we have a better understanding of what we can use R Markdown files for, let's start writing a report!

To create an R Markdown file:
- Open RStudio
- Go to File &rarr; New File &rarr; R Markdown
- Give your document a title, something like "The relationship between smoking and lung cancer rates" (Note: this is not the same as the file name - it's just a title that will appear at the top of your report)
- Keep the default output format as HTML
- Note: R Markdown files always end in `.Rmd`

> ## R Markdown Outputs
> The default output for an R Markdown report is HTML, but you can also use R Markdown to [output other report formats](https://rmarkdown.rstudio.com/lesson-9.html). For example, you can generate PDF reports using R Markdown, but you must [install TeX](https://www.latex-project.org/get/) to do this.
>
{: .callout}


## Basic components of R Markdown
_[Back to top](#contents)_

### Header
_[Back to top](#contents)_

The first part of every R markdown file is a *header* at the top of the file between the lines of `---`. This contains instructions for R to specify the type of document to be created and options to choose (ex., title, author, date). These are in the form of key-value pairs (`key: value`; YAML).

Here's an example:

```
---
title: 'The relationship between smoking and lung cancer rates'
author: "Zena Lapp"
date: "July 14, 2022"
output: html_document
---
```

### Code chunks
_[Back to top](#contents)_

The next section is a *code chunk*, or embedded R code, that sets up options for all code chunks. Here is the default when you create a new R Markdown file:

```{r,comment=NA,echo=F,collapse=T}
cat('```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n')
```

All code chunks have this format:

```{r,comment=NA,echo=F,collapse=T}
cat('```{r}\n# Your code here\n```')
```

All of the code is enclosed in 3 back ticks (`r cat("\x60\x60\x60")`), and the `{r}` part indicates that it's a chunk of R code.

You can also include other information within the curly brackets to indicate different information about that code chunk.
For instance, the first code block is named "setup", and `include=FALSE` prevents code and results from showing up in the output file.

Inside the code chunk, you can put any R code that you want to run, and you can have as many code chunks as you want in your file.

As we mentioned above, in the first code chunk you set options for the entire file.
`echo = TRUE` means that you want your code to be shown in the output file. If you change this to `echo = FALSE`, then the code will be hidden and only the output of the code chunks will be seen in the output file.
There are also [many other options that you can change](https://rmarkdown.rstudio.com/lesson-3.html), but we won't go into those details in this workshop.


### Text
_[Back to top](#contents)_

Finally, you can include text in your R Markdown file.
This is any text or explanation you want to include, and it's formatted with Markdown.
We'll learn more about Markdown formatting soon!

## Starting the report
_[Back to top](#contents)_

Let's return to the new R Markdown file you created and delete everything below the setup code chunk. (That stuff is just examples and reminders of how to use R Markdown.)

Next, let's save our R markdown file to the `reports` directory.
You can do this by clicking the save icon in the top left or using <kbd>control</kbd> + <kbd>s</kbd> (<kbd>command</kbd> + <kbd>s</kbd>  on a Mac).

### Change knit directory

There's one other thing that we need to do before we get started with our report.
To render our documents into html format, we can "knit" them in R Studio.
Usually, R Markdown renders documents from the directory where the document is saved (the location of the `.Rmd` file), but we want it to render from the main project directory where our `.Rproj` file is.
This is because that's where all of our relative paths are from and it's good practice to have all of your relative paths from the main project directory.
To change this default, click on the down arrow next to the "Knit" button at the top left of R Studio, go to "Knit Directory" and click "Project Directory".
Now it will assume all of your relative paths for reading and writing files are from the `un-report` directory, rather than the `reports` directory.

Now that we have that set up, let's start on the report!

### Add code

We're going to use the code you generated yesterday to plot smoking rates vs. lung cancer rates to include in the report. Recall that we needed a couple R packages to generate these plots. We can create a new code chunk to load the needed packages. You could also include this in the previous setup chunk, it's up to your personal preference.

```{r,comment=NA,echo=F,collapse=T}
cat('```{r packages}\nlibrary(tidyverse)\n```\n')
```

Now, in a real report this is when we would type out the background and purpose of our analysis to provide context to our readers. However, since writing is not a focus of this workshop we will avoid lengthy prose and stick to short descriptions. You can copy the following text  into your own report below the package code chunk.

```
This report was prepared to the attention of the United Nations. It analyzes the relationship between a country's lung cancer rate, smoking rate, and air pollution. Our goal is to determine to what degree the percent of people who smoke and the amount of air pollution may be related to its lung cancer rate. We hypothesize that lung cancer rates increase with both percent of people who smoke and the amount of air pollution.
```

Now, since we want to show our results comparing smoking rate and lung cancer rate by country, we need to read in this data so we can generate our plot. We will add another code chunk to prepare the data.

```{r,comment=NA,echo=F,collapse=T}
cat('```{r data}\nsmoking <- read_csv("data/smoking_cancer.csv")\n```\n')
```

### Plot

Now that we have the data, we need to produce the plot. Let's create it using the most recent year in our dataset:

```{r,comment=NA,echo=F,collapse=T}
cat('```{r smoking_cancer}\nsmoking %>%
  filter(year == max(year)) %>% 
  ggplot(aes(x = smoke_pct, y = lung_cancer_pct, color=continent, size=pop/1000000)) + 
  geom_point() +
  labs(x = "Percent of people who smoke", y = "Percent of people with lung cancer",
       title= "Are lung cancer rates associated with smoking rates?", size="Population (in millions)")\n```')
```

### Table

Let's say we also want to include a table in our report that summarizes the number of countries, the minimum smoker percent, and the maximum smoker percent.

> ## Review: calculating summary statistics 
> For the year 2019, calculate the minimum, median, and maximum for the percent of smokers in a given country. 
>
> > ## Solution
> > ```{r}
> > smoking %>% 
> >   filter(year == 2019) %>% 
> >   summarize(min_smoke = min(smoke_pct),
> >             median_smoke = median(smoke_pct),
> >             max_smoke = max(smoke_pct))
> > ```
> {: .solution}
{: .challenge}

### Knitting

Now we can knit our document to see how our report looks! Use the <kbd>knit</kbd> button in the top left of the screen.

![]({{ page.root }}/fig/r-markdown/first_report_render.png)

Amazing! We've created a report! 

It's looking pretty good, but there seem to be a few extra bits that we might not need in the report. For example, what if we want to make a report that doesn't print out all of the messages from the tidyverse? Or a report that doesn't show the code? And the table is a bit ugly. Let's make things a bit prettier. 

## Customizing the report

### Table format

We can make the table prettier using the R function `kable()`. We can give the `kable()` function a tibble and it will format it to a nice looking table in the report. The `kable()` function comes from the `knitr` packages, so what do we have to do before using the function? We have to load the `knitr` library.

```{r,comment=NA, collapse=T, warning = FALSE}
# load library
library(knitr)

# print kable
smoking %>% 
   filter(year == 2019) %>% 
   summarize(min_smoke = min(smoke_pct),
             median_smoke = median(smoke_pct),
             max_smoke = max(smoke_pct)) %>%
  kable()
```

### Messages

How do we get rid of the tidyverse messages? One way to do this is by saying `include = FALSE` in the curly brackets for that code chunk:

```{r,comment=NA,echo=F,collapse=T}
cat('```{r packages, include=FALSE}\nlibrary(tidyverse)\n```\n')
```

This will get rid of the code and the corresponding messages. But what if we want to include the code so that people know we loaded the tidyverse? In this case, we can say `message=FALSE` inside the curly brackets:

```{r,comment=NA,echo=F,collapse=T}
cat('```{r packages, message=FALSE}\nlibrary(tidyverse)\n```\n')
```

### Code

We can also see the code that was used to generate the plot. Depending on the purpose and audience for your report, you may or may not want to include the code. If you don't want the code to appear, how can you prevent it? 

> ## Code chunk options
> Which of the following would lead to a report with no code chunks? For the ones that would not work, what would happen instead?
> 1. Add `echo = FALSE` inside the curly brackets of the plotting code chunk.
> 1. Add `include = FALSE` inside the curly brackets of the plotting code chunk.
> 1. Add `echo = FALSE` inside the curly brackets of the setup code chunk.
> 1. Change `echo = TRUE` to `echo = FALSE` in the `knitr::opts_chunk$set()` function in the first code chunk. 
>
> > ## Solution
> > 1. This would only remove the code for the plotting code chunk, but not the packages code chunk. 
> > 1. This would remove the code but also the plot from the report. 
> > 1. This would not change anything because that code chunk is already excluded because `include = FALSE`.
> > 1. This would remove all code from the output file (what we want). 
> {: .solution}
{: .challenge}

### Bonus 

> ## Dynamically updating text using mini R chunks
> Sometimes, you want to describe your data or results (like our plot) to the audience in text but the data and results may still change as you work things out. R Markdown offers an easy way to do this dynamically, so that the text updates as your data or results change. Here is how to do this.
> 
> Let's create a code chunk that summarizes features of our data that we can use to describe our plot to  our audience. Note that we set `include=FALSE` because we only want this step to happen in the background. For our purposes, we will calculate how many countries were included in the analysis, as well as the minimum and maximum percent of smokers.
> > ## Calculating summary statistics
> > Perform the following steps to calculate summary statistics:
> > 1. Create a subsetted `smoking` datset including only data from 2019 an save it to the variable `smoking_2019`. 
> > 1. Look up how to use the function `n_distinct()` and use it to find the number of distinct countries in `smoking_2019`. HINT: You can pick the column you're interested in using `select()` and then pipe that to `n_distinct()`. 
> > 1. Find the minimum value of `smoke_pct` and round it to 1 decimal place.
> > 1. Find the maximum value of `smoke_pct` and round it to 1 decimal place.
> >
> > > ## Solution
> > > ```{r}
> > > smoking_2019 <- smoking %>% 
> > >   filter(year == 2019)
> > > smoking_2019 %>%
> > >   select(country) %>%
> > >   n_distinct()
> > > smoking_2019 %>%
> > >   summarise(round(min(smoke_pct), 1))
> > > smoking_2019 %>%
> > >   summarise(round(max(smoke_pct), 1)) 
> > > ```
> > {: .solution}
> {: .challenge}
> Let's fix up the code you wrote in the previous section a bit to make it easier to use for our purposes. 
> We have to save each number to its own variable and make sure each value is just one number (not a tibble). To un-tibble a number, you can use the `pull()` function.
> 
> ```{r data_summary, message = FALSE}
> smoking_2019 <- smoking %>% 
>   filter(year == 2019)
> 
> n_countries <- smoking_2019 %>%
>   select(country) %>%
>   n_distinct()
> 
> min_smoke <- smoking_2019 %>%
>   summarise(round(min(smoke_pct), 1)) %>%
>   pull()
> 
> max_smoke <- smoking_2019 %>%
>   summarise(round(max(smoke_pct), 1)) %>%
>   pull()
> ```
> Now, all we need to do is reference the values we just computed to describe our
plot. To do this, we enclose each value in one set of backticks 
(`` `r '\x60r some_R_variable_name \x60'` ``), while the ``r`` part once again
indicates that it's a chunk of R code. When we knit our report, R will
automatically fill in the values we just created in the above code chunk. Note
that R will automatically update these values every time our data might change
(if we were to decide to drop or add countries to this  analysis, for example).
> 
> ```
> The above plot shows the relationship between percent of smokers and percent of people with lung cancer for a total of `r '\x60r n_countries \x60'` countries. 
For this set of countries, the percent of smokers ranged from a minimum of `r '\x60r min_smoke\x60'` to a maximum of `r '\x60r max_smoke\x60'`.
> ```
{: .callout}


## Formatting
_[Back to top](#contents)_

We now know how to create a report with R Markdown. Maybe we also want to format the report a little bit to structure our thought process in a useful way (e.g., sections) and make it visually appealing?
Markdown is like a simple programming language when it comes to syntax.
Let's try to figure out some syntax together. Suppose we wanted to create sections in our report.

### Headers

To create different sections by using headers and sub-headers, you can use the `#` (pound/hash) sign. Our main headers have one `#` (e.g. `# Main Header Here`) and to create subheaders we add additinal `#`s (e.g. `## First subheader` and `### Second subheader`)

### Lists

To create a bulleted list in R Markdown, you can use the `-` (dash) or the `*` (asterisk).
Create a bulleted list with three items:

```
* The name of your currently favorite programming language 
* The name of a function you have so far found most useful 
* One thing you want to learn next on your programming journey
```

> ## Bold and italics 
> Use the Internet or the [R Markdown reference guide](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf) to figure out how to: 1) bold the text of the first bullet point, 2) italicize the text of the second bullet point, 3) bold and italicize the text of the third bullet point.
> > ## Solution
> > Italics can be generated by enclosing the text in `_` (single underscores) or `*` (single asterisks), and bold in `__` (double underscores) or `**` (double asterisks). To use both, use three instead underscores (`___`) or asterisks (`***`) instead. 
> {: .solution}
{: .challenge}

Okay, now how do you think we'd turn our bulleted list into a numbered list?

You can change the bullets to numbers with dots after them:

```
1. The name of your currently favorite programming language 
2. The name of a function you have so far found most useful 
3. One thing you want to learn next on your programming journey
```

Or, even better, you can just make them all `1.` and markdown will be smart enough to number them in order. This is super useful if you end up wanting to add in an item in the middle of the list:

```
1. The name of your currently favorite programming language 
1. The name of a function you have so far found most useful 
1. One thing you want to learn next on your programming journey
```

# Applying it to your own data

Now it's time to merge all of your analyses with your own data together into a report. Fill out the worksheet to outline your report and then start making it!
